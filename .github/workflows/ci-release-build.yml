on: push
name: Release Build

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BT_DIR: ${{ github.workspace }}/BATTLETECH
      ME_DIR: ${{ github.workspace }}/MechEngineer
    steps:
    - name: Setup dotnet
      uses: actions/setup-dotnet@master
      with:
        dotnet-version: '6.0'
        include-prerelease: true
    - name: Download Dependencies
      env:
        MANAGED_ARCHIVE_PW: ${{ secrets.MANAGED_ARCHIVE_PW }}
        MANAGED_ARCHIVE_URL: ${{ secrets.MANAGED_ARCHIVE_URL }}
      run: |
        # TODO split Managed and publicized
        # BattleTech Managed Publicized
        curl -L -o "$GITHUB_WORKSPACE/Managed.7z" "$MANAGED_ARCHIVE_URL"
        MANAGED_DIR="$BT_DIR/BattleTech_Data/Managed"
        mkdir -p "$MANAGED_DIR"
        7z e -p"$MANAGED_ARCHIVE_PW" -o"$MANAGED_DIR" "$GITHUB_WORKSPACE/Managed.7z"
        # CustomComponents
        curl -L -o CustomComponents.zip https://github.com/BattletechModders/CustomComponents/releases/download/latest/CustomComponents.zip
        unzip CustomComponents.zip
    - name: Checkout
      uses: actions/checkout@master
      with:
        path: ${{ env.ME_DIR }}
    - name: Fetch Branches and Tags
      run: cd "$ME_DIR" && git fetch --prune --unshallow
    - name: Build Release
      run: cd "$ME_DIR" && ./release.sh "-p:BattleTechGameDir=$BT_DIR"
    - name: Release Latest
      uses: "marvinpinto/action-automatic-releases@latest"
      if: github.ref == 'refs/heads/master'
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        automatic_release_tag: "latest"
        title: "Latest (unstable)"
        prerelease: true
        files: |
          ./MechEngineer/dist/MechEngineer.zip
    - name: Release stable
      uses: "softprops/action-gh-release@master"
      if: startsWith(github.ref, 'refs/tags')
      with:
        draft: false
        prerelease: false
        body: |
          Works with best with ModTek v2
          - MechEngineer.zip contains only the bare bones mod + CustomComponents
        files: "./MechEngineer/dist/MechEngineer.zip"
